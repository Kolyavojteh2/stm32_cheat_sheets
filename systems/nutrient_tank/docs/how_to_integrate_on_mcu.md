# How to use it in your system
This is not accurate instruction how to integrate into your system. It was generated by chatgpt. While reading this steps I found that function signatures are not accurate, this why you have to use this as a base, but not as a good example how to use it.

#### TODO: update this instruction once it is integrated on the MCU.

## Example distance->volume
```
#include <stdint.h>

typedef struct
{
    /* distance_mm -> volume_ul: volume = k * (d0 - d) */
    uint32_t dist_empty_mm;     /* distance when empty */
    uint32_t dist_full_mm;      /* distance when full */
    uint32_t volume_full_ul;    /* max volume */
} TankMapLinear_t;

static uint32_t tank_map_linear_ul(void *ctx, uint32_t distance_mm)
{
    TankMapLinear_t *m = (TankMapLinear_t *)ctx;

    if (m == NULL) {
        return 0U;
    }

    if (distance_mm >= m->dist_empty_mm) {
        return 0U;
    }

    if (distance_mm <= m->dist_full_mm) {
        return m->volume_full_ul;
    }

    /* Linear interpolation between full and empty */
    {
        uint32_t span_d = m->dist_empty_mm - m->dist_full_mm;
        uint32_t x = m->dist_empty_mm - distance_mm; /* 0..span_d */
        uint64_t v = (uint64_t)m->volume_full_ul * (uint64_t)x;
        v = v / (uint64_t)span_d;
        return (uint32_t)v;
    }
}
```

## Object initialization
```
#include "nutrient_tank.h"
#include "tank_sensors.h"
#include "recipe_controller.h"
#include "pump_unit.h"
#include "pump_guard.h"

/* --------- GPIO switch wrappers (example) --------- */
/* You already have GPIO_switch_t in your project. */

/* --------- Instances --------- */
static NutrientTank_t g_tank;

static TankSensors_t g_sensors;
static RecipeController_t g_recipe;

/* Pump units */
static PumpUnit_t g_pump_water;
static PumpUnit_t g_pump_nutr[4];
static PumpUnit_t g_pump_ph_up;
static PumpUnit_t g_pump_ph_down;
static PumpUnit_t g_pump_air;
static PumpUnit_t g_pump_circ;
static PumpUnit_t g_pump_return;

/* Guards */
static PumpGuard_t g_guard_water;
static PumpGuard_t g_guard_nutr[4];
static PumpGuard_t g_guard_ph_up;
static PumpGuard_t g_guard_ph_down;
static PumpGuard_t g_guard_circ;
static PumpGuard_t g_guard_return;

/* Level maps */
static TankMapLinear_t g_main_map;
static TankMapLinear_t g_return_map;

static uint8_t system_init_nutrient_tank(void)
{
    NutrientTank_Config_t cfg;
    NutrientTank_Timing_t timing;
    RecipeController_Config_t rcfg;
    RecipeController_Targets_t targets;

    /* --------- Sensors storage --------- */
    tank_sensors_init(&g_sensors);

    /* Optional: configure stale thresholds if present in your TankSensors */
    /* g_sensors.stale_timeout_ms = 8000U; */

    /* --------- Volume mapping --------- */
    g_main_map.dist_empty_mm = 300U;
    g_main_map.dist_full_mm = 50U;
    g_main_map.volume_full_ul = 20000000U; /* 20 L */

    g_return_map.dist_empty_mm = 250U;
    g_return_map.dist_full_mm = 40U;
    g_return_map.volume_full_ul = 8000000U; /* 8 L */

    /* --------- Pump calibration (example numbers!) --------- */
    /* flow_ul_per_s must be calibrated per pump */
    pump_unit_init(&g_pump_water,   /*GPIO*/ NULL, 20000U);  /* 20 ml/s */
    pump_unit_init(&g_pump_ph_up,   NULL,  2000U);          /* 2 ml/s */
    pump_unit_init(&g_pump_ph_down, NULL,  2000U);
    pump_unit_init(&g_pump_air,     NULL,  0U);             /* air pump: run by time only */
    pump_unit_init(&g_pump_circ,    NULL,  50000U);         /* 50 ml/s */
    pump_unit_init(&g_pump_return,  NULL,  40000U);         /* 40 ml/s */

    for (uint8_t i = 0; i < 4; i++) {
        pump_unit_init(&g_pump_nutr[i], NULL, 5000U);       /* 5 ml/s each */
    }

    /* --------- Guards setup (example) --------- */
    pump_guard_init(&g_guard_water, &g_pump_water);
    pump_guard_set_max_run_ms(&g_guard_water, 30000U);

    for (uint8_t i = 0; i < 4; i++) {
        pump_guard_init(&g_guard_nutr[i], &g_pump_nutr[i]);
        pump_guard_set_max_run_ms(&g_guard_nutr[i], 30000U);
    }

    pump_guard_init(&g_guard_ph_up, &g_pump_ph_up);
    pump_guard_set_max_run_ms(&g_guard_ph_up, 15000U);

    pump_guard_init(&g_guard_ph_down, &g_pump_ph_down);
    pump_guard_set_max_run_ms(&g_guard_ph_down, 15000U);

    pump_guard_init(&g_guard_circ, &g_pump_circ);
    pump_guard_set_max_run_ms(&g_guard_circ, 600000U); /* 10 min safety */

    pump_guard_init(&g_guard_return, &g_pump_return);
    pump_guard_set_max_run_ms(&g_guard_return, 180000U);

    /* --------- RecipeController config --------- */
    memset(&rcfg, 0, sizeof(rcfg));

    rcfg.max_total_dose_ul = 500000U;      /* 500 ml per control session */
    rcfg.max_single_dose_ul = 20000U;      /* 20 ml per one step chunk */
    rcfg.ph_step_ul = 1000U;              /* 1 ml */

    rcfg.nutrient_count = 4U;

    /* Proportions on 1L: 2:1:2:1 (parts per liter) */
    rcfg.nutrient_parts_per_l[0] = 2U;
    rcfg.nutrient_parts_per_l[1] = 1U;
    rcfg.nutrient_parts_per_l[2] = 2U;
    rcfg.nutrient_parts_per_l[3] = 1U;
    rcfg.nutrient_part_volume_ul = 1000U; /* 1 ml per part */

    /* Adaptive nutrient steps */
    rcfg.tds_nutrient_err_full_ppm = 200U;
    rcfg.tds_nutrient_portion_min_x1000 = 100U;   /* 0.1 */
    rcfg.tds_nutrient_portion_max_x1000 = 1000U;  /* 1.0 */

    /* Adaptive water dilution steps (gentler) */
    rcfg.tds_water_err_full_ppm = 300U;
    rcfg.tds_water_portion_min_x1000 = 50U;  /* 0.05 */
    rcfg.tds_water_portion_max_x1000 = 400U; /* 0.4 */

    /* Optional: if you want explicit per-liter base steps:
       rcfg.tds_nutrient_step_ul_per_l = 600U;  // 0.6 ml/L
       rcfg.tds_water_step_ul_per_l = 300U;     // 0.3 ml/L
       else it uses derived from parts (full portion = 6 ml/L) scaled by portion_x1000
    */

    if (recipe_controller_init(&g_recipe, &rcfg) == 0U) {
        return 0U;
    }

    memset(&targets, 0, sizeof(targets));
    targets.enable_ph = 1U;
    targets.enable_tds = 1U;
    targets.target_ph_x1000 = 6000;       /* 6.0 */
    targets.ph_tolerance_x1000 = 100;     /* +-0.1 */
    targets.target_tds_ppm = 1100;
    targets.tds_tolerance_ppm = 50;

    recipe_controller_set_targets(&g_recipe, &targets);

    /* --------- NutrientTank timing --------- */
    memset(&timing, 0, sizeof(timing));
    timing.after_dose_aerate_ms = 15000U;
    timing.after_dose_settle_ms = 15000U;
    timing.after_aerate_settle_ms = 10000U;
    timing.control_measurement_timeout_ms = 60000U;

    /* --------- NutrientTank config --------- */
    memset(&cfg, 0, sizeof(cfg));

    cfg.sensors = &g_sensors;
    cfg.recipe = &g_recipe;

    cfg.timing = timing;

    /* Main tank level mapping */
    cfg.main_level.map_fn = tank_map_linear_ul;
    cfg.main_level.map_ctx = &g_main_map;

    /* Return tank mapping (optional) */
    cfg.return_level.map_fn = tank_map_linear_ul;
    cfg.return_level.map_ctx = &g_return_map;

    /* Hook pumps/guards into cfg: depends on your actual NutrientTank_Config_t layout.
       The idea:
       - water pump guard pointer
       - nutrient guards array
       - ph up/down guards
       - air pump unit/guard
       - circulation guard
       - return guard
    */

    /* Example pseudo:
       cfg.pumps.water = &g_guard_water;
       cfg.pumps.nutrient[0] = &g_guard_nutr[0]; ...
       cfg.pumps.ph_up = &g_guard_ph_up;
       cfg.pumps.ph_down = &g_guard_ph_down;
       cfg.pumps.air = &g_pump_air;
       cfg.pumps.circ = &g_guard_circ;
       cfg.pumps.return = &g_guard_return;
    */

    if (nutrient_tank_init(&g_tank, &cfg) == 0U) {
        return 0U;
    }

    return 1U;
}

```

## Update water levels:
```
static void task_read_levels(uint32_t now_ms)
{
    uint32_t main_dist_mm = 0U;
    uint32_t return_dist_mm = 0U;

    /* Read SR04M sensors (your driver) */
    /* main_dist_mm = sr04m_get_distance_mm(&sr04_main); */
    /* return_dist_mm = sr04m_get_distance_mm(&sr04_return); */

    nutrient_tank_update_main_distance_mm(&g_tank, main_dist_mm, now_ms);
    nutrient_tank_update_return_distance_mm(&g_tank, return_dist_mm, now_ms);
}
```

## Update chemistry:
```
static void task_read_chemistry(uint32_t now_ms)
{
    int32_t ph_x1000 = 0;
    int32_t tds_ppm = 0;
    int32_t temp_mC = 0;

    /* Read sensors (your drivers) */
    /* ph_x1000 = ph_sensor_read_x1000(&ph); */
    /* tds_ppm = tds_read_ppm(&tds); */
    /* temp_mC = ds18b20_read_mC(&ds); */

    tank_sensors_update_ph_x1000(&g_sensors, ph_x1000, now_ms, 1U);
    tank_sensors_update_tds_ppm(&g_sensors, tds_ppm, now_ms, 1U);
    tank_sensors_update_temperature_mC(&g_sensors, temp_mC, now_ms, 1U);
}
```

## Main loop:
```
static void handle_events(void)
{
    NutrientTank_Event_t ev;

    while (nutrient_tank_pop_event(&g_tank, &ev) != 0U) {

        switch (ev.type) {

        case NUTRIENT_TANK_EVENT_CONTROL_DONE:
            /* log / notify */
            break;

        case NUTRIENT_TANK_EVENT_CONTROL_ERROR:
            /* log error + reason */
            break;

        case NUTRIENT_TANK_EVENT_MAIN_LOW:
            /* maybe schedule refill */
            break;

        case NUTRIENT_TANK_EVENT_REQUEST_RETURN:
            /* you can submit RETURN command if you use manual scheme */
            break;

        default:
            break;
        }
    }
}

int main(void)
{
    HAL_Init();
    SystemClock_Config();
    /* init peripherals */

    if (system_init_nutrient_tank() == 0U) {
        /* fatal */
        while (1) {}
    }

    /* Example: start control */
    {
        NutrientTank_Command_t cmd;
        memset(&cmd, 0, sizeof(cmd));
        cmd.type = NUTRIENT_TANK_CMD_CONTROL_START;
        nutrient_tank_submit_command(&g_tank, &cmd);
    }

    while (1) {

        uint32_t now_ms = HAL_GetTick();

        /* Run periodic sensor tasks (can be timer-driven too) */
        task_read_levels(now_ms);
        task_read_chemistry(now_ms);

        /* Run FSM */
        nutrient_tank_process(&g_tank, now_ms);

        /* Handle events */
        handle_events();

        /* small delay if needed */
        /* HAL_Delay(5); */
    }
}
```

## Manual commands examples:
### Manual dose 50 ml of water
```
NutrientTank_Command_t cmd;
memset(&cmd, 0, sizeof(cmd));

cmd.type = NUTRIENT_TANK_CMD_DOSE_VOLUME;
cmd.dose.kind = NUTRIENT_TANK_DOSE_WATER;
cmd.dose.volume_ul = 50000U; /* 50 ml */

nutrient_tank_submit_command(&g_tank, &cmd);

```

### Switch on aeration for 20 seconds
```
NutrientTank_Command_t cmd;
memset(&cmd, 0, sizeof(cmd));

cmd.type = NUTRIENT_TANK_CMD_AERATE_FOR_MS;
cmd.aerate.duration_ms = 20000U;

nutrient_tank_submit_command(&g_tank, &cmd);
```

### Emergency stop
```
NutrientTank_Command_t cmd;
memset(&cmd, 0, sizeof(cmd));
cmd.type = NUTRIENT_TANK_CMD_EMERGENCY_STOP;
nutrient_tank_submit_command(&g_tank, &cmd);
```
